<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>SIAP MACET – Monitoring Lalu Lintas Sukabumi</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: #020617;
            color: #e5e7eb;
        }

        #map {
            height: 100%;
            width: 100%;
            display: none;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #020617, #000);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 14px;
            z-index: 9999;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.15);
            border-top-color: #38bdf8;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            font-size: 14px;
            opacity: 0.85;
        }

        .error {
            margin-top: 10px;
            color: #f87171;
            font-size: 14px;
            display: none;
        }

        .fade-out {
            animation: fadeOut .4s ease forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">
            Menghubungi server…
        </div>
        <div class="error" id="loaderError"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_BASE = "http://127.0.0.1:8000";

        const loader = document.getElementById("loader");
        const loaderText = document.getElementById("loaderText");
        const loaderError = document.getElementById("loaderError");
        const mapDiv = document.getElementById("map");

        function showError(msg) {
            loaderError.textContent = msg;
            loaderError.style.display = "block";
            loaderText.textContent = "Gagal memuat data";
        }

        function hideLoader() {
            loader.classList.add("fade-out");
            setTimeout(() => {
                loader.style.display = "none";
                mapDiv.style.display = "block";
                map.invalidateSize();
            }, 400);
        }

        const map = L.map("map").setView([-6.9175, 106.929], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap"
        }).addTo(map);

        function colorBySpeed(speed) {
            if (speed === null || speed === undefined) return "#22c55e";
            if (speed < 20) return "#ef4444";
            if (speed < 35) return "#facc15";
            return "#22c55e";
        }

        async function loadData() {
            try {
                loaderText.textContent = "Mengambil data jalan…";
                const roadsRes = await fetch(`${API_BASE}/roads`);
                if (!roadsRes.ok) throw new Error("Gagal mengambil data jalan");
                const roadsGeoJSON = await roadsRes.json();

                loaderText.textContent = "Mengambil data traffic…";
                const trafficRes = await fetch(`${API_BASE}/traffic_snapshot`);
                const trafficData = trafficRes.ok ? await trafficRes.json() : [];

                const trafficMap = {};
                for (const t of trafficData) {
                    trafficMap[t.road_id] = t;
                }

                const roadLayer = L.geoJSON(roadsGeoJSON, {
                    style: feature => {
                        const t = trafficMap[feature.properties.road_id];
                        return {
                            color: colorBySpeed(t?.speed),
                            weight: 5,
                            opacity: 0.9
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const p = feature.properties;
                        const t = trafficMap[p.road_id];

                        let trafficInfo = "Data traffic belum tersedia";
                        if (t) {
                            trafficInfo = `
                        Kecepatan: ${t.speed} km/h<br>
                        Free flow: ${t.free_flow} km/h<br>
                        Confidence: ${t.confidence}
                    `;
                        }

                        layer.bindPopup(`
                    <b>${p.road_name}</b><br>
                    ID: ${p.road_id}<br>
                    Bobot: ${p.road_weight}<br><br>
                    ${trafficInfo}
                `);
                    }
                }).addTo(map);

                map.fitBounds(roadLayer.getBounds(), { padding: [30, 30] });
                hideLoader();

            } catch (err) {
                console.error(err);
                showError(err.message || "Terjadi kesalahan");
            }
        }

        loadData();
    </script>

</body>

</html>